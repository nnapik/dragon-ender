[include KAMP_Settings.cfg]

[gcode_macro SMART_HOME]
gcode:
    {% if printer.toolhead.homed_axes != "xyz" %}
        M118 Homing
        G28
    {% else %} 
        M118 Already Homed
    {% endif %}

[gcode_macro SCREWS]
gcode:
    SMART_HOME
    SCREWS_TILT_CALCULATE

[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    G90 # Use absolute coordinates
    M140 S{BED_TEMP} # Start bed heating
    M104 S150 # start nozzle heating, set temporary nozzle temp to prevent oozing during homing
    M190 S{BED_TEMP} # Wait for bed to reach temperature
    G28
    BED_MESH_CALIBRATE
    M104 S{EXTRUDER_TEMP} #Set final nozzle temp
    G1 Z50 F240 #Move the head to Z50
    G1 X10 Y10 F3000 #Move the head to bottom left corner
    M109 S{EXTRUDER_TEMP} # Wait for nozzle to reach temperature
    LINE_PURGE

[gcode_macro STOP_PRINT]
gcode:
    G91 #set relative coordinates
    G1 E-40 F2000 #retract quickly to clear the nozzle
    G1 Z5 F250 #move z UP 5mm
    G90 #set absolute coords
    G1 X10 Y200 F3000 #move head to the left and bed to the front
    M140 S0 #turn off the bed
    M104 S0 #turn off the nozzle
    M107 # Turn off the fan
    M84 X Y E #Disable motors
    UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30